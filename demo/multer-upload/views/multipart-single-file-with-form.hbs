{{!< layout/default}}
{{#contentFor 'title'}}{{title}}{{/contentFor}}

<div class="upload-section">
  <h2>Single File Upload with Text Data <span class="text-muted" style="font-size: 0.9rem;">(multipart/form-data)</span></h2>
  <p>Upload a single file with additional text fields</p>

  <div class="alert alert-primary" style="font-size: 0.875rem;">
    The server returns the uploaded file and form data it received. Verify that the response matches what you sent (file info, username, email, etc.).
  </div>

  <form id="singleFileWithDataForm" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="username2" class="form-label">Username:</label>
      <input type="text" class="form-control" id="username2" name="username" value="john_doe">
    </div>
    <div class="mb-3">
      <label for="email2" class="form-label">Email:</label>
      <input type="email" class="form-control" id="email2" name="email" value="john@example.com">
    </div>
    <div class="mb-3">
      <label for="avatar2" class="form-label">Avatar:</label>
      <input type="file" class="form-control" id="avatar2" name="avatar">
    </div>
    <button type="submit" class="btn btn-primary">Upload File with Data</button>
  </form>
  <div id="singleWithDataResult" class="mt-3" style="display: none;">
    <div id="singleWithDataResultContent"></div>
  </div>
</div>

{{#contentFor 'script'}}
<script>
  function displayFiles(result, contentEl) {
    let html = '<pre>' + JSON.stringify(result, null, 2) + '</pre>';

    if (result.success && result.file && result.file.path) {
      const isImage = result.file.mimetype && result.file.mimetype.startsWith('image/');
      html += '<div style="margin-top: 1rem;">';
      html += `<div><strong>${result.file.originalname}</strong> (${result.file.filename})</div>`;
      if (isImage) {
        html += `<img src="${result.file.path}" alt="${result.file.originalname}" style="max-width: 300px; margin-top: 0.5rem;">`;
      }
      html += '</div>';
    }

    contentEl.innerHTML = html;
  }

  document.getElementById('singleFileWithDataForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
      const response = await fetch('/api/multipart-single-file-with-form', {
        method: 'POST',
        body: formData
      });
      const result = await response.json();

      document.getElementById('singleWithDataResult').style.display = 'block';
      displayFiles(result, document.getElementById('singleWithDataResultContent'));
    } catch (error) {
      document.getElementById('singleWithDataResult').style.display = 'block';
      document.getElementById('singleWithDataResultContent').textContent = 'Error: ' + error.message;
    }
  });
</script>
{{/contentFor}}
